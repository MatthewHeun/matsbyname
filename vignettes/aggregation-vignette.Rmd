---
title: "Aggregation in `matsbyname`"
author: "Matthew Kuperus Heun"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    smart: false
vignette: >
  %\VignetteIndexEntry{Aggregation in `matsbyname`}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(dplyr)
library(tidyr)
library(matsbyname)
library(matsindf)
```


## Introduction

The `matsbyname` package provides several
functions to assist renaming and aggregating rows and columns of matrices.
This vignette shows how to use those functions.


## `aggregate_byname()`

By default (`aggregation_map = NULL, margin = c(1,2), pattern_type = "exact"`),
`aggregate_byname()` sums all rows and columns with the same names, 
with the effect that remaining row and column names are unique.

```{r}
m <- matrix(c(1, 2, 3, 4, 
              5, 6, 7, 8, 
              9, 10, 11, 12), nrow = 3, ncol = 4, byrow = TRUE,
            dimnames = list(c("duck", "duck", "goose"), 
                            c("John", "Paul", "George", "Ringo")))
m
aggregate_byname(m)
```

An `aggregation_map` can be provided,
giving instructions for rows or columns to aggregate and 
the names of the results.
`aggregation_map` should be a list of named strings.
The entries in the list give names of rows and columns to be aggregated.
The names of the list entries provide the names of the resulting aggregates.

```{r}
m
aggregate_byname(m, aggregation_map = list(birds = c("duck", "goose"), 
                                           guitarists = c("John", "Paul", "George")))
```

The margin over which the aggregation is to be performed 
is given by the `margin` argument
(`1` for rows, `2` for columns). 

```{r}
m
aggregate_byname(m, aggregation_map = list(Beatles = c("John", "Paul", "George", "Ringo")), 
                 margin = 2)
```

`aggregation_map` can use regular expressions to identify rows and columns to aggregate.
Use `pattern_type = "literal"` for this feature.

```{r}
m
aggregate_byname(m, aggregation_map = list(guitarists = "^[JPG]"), 
                 margin = 2, pattern_type = "literal")
```


Note that rows and columns of aggregated matrices 
are always sorted alphabetically.

```{r}
m
aggregate_byname(m, aggregation_map = list(birds = c("duck", "goose"), 
                                           zguitarists = c("John", "Paul", "George")))
```

It is an error to aggregate over a margin and leave 
identically named rows or columns. 
The following function call will fail, 
because it aggregates over both rows and columns
(using the default `margin = c(1,2)`)
with nothing in the `aggregation_map` to aggregate the two "duck" rows.

```{r, eval=FALSE}
# Not run
aggregate_byname(m, aggregation_map = list(Beatles = c("John", "Paul", "George", "Ringo")))
```



## Pieces

Commonly, row and column names are complex, 
carrying information 
in prefixes, suffixes, and prepositional phrases.
`matsbyname` can aggregate by pieces of a name, 
using the `RCLabels` package internally.

We'll use the following matrix to demonstrate aggregating by pieces.
The rows and columns use different notations for names
("bracket" notation for rows and "arrow" notation for columns). 
The renaming and aggregation capabilities of `matsbyname`
still work, despite the different notations.

```{r}
m_pieces <- matrix(c(1, 2, 3,
                     4, 5, 6), nrow = 2, ncol = 3, byrow = TRUE, 
                   dimnames = list(c("Electricity [from Coal]", "Electricity [from Solar]"), 
                                   c("Motors -> MD", "Cars -> MD", "LED lamps -> Light")))
m_pieces
```


## `rename_to_piece_byname()`

Rows and columns can be renamed to their prefixes, suffixes, or objects of prepositions,
as demonstrated below.

```{r}
m_pieces
rename_to_piece_byname(m_pieces, piece = "pref", margin = 1, 
                       notation = RCLabels::bracket_notation)
rename_to_piece_byname(m_pieces, piece = "suff", margin = 1, 
                       notation = RCLabels::bracket_notation)
rename_to_piece_byname(m_pieces, piece = "from", margin = 1, 
                       notation = RCLabels::bracket_notation)
rename_to_piece_byname(m_pieces, piece = "pref", margin = 2,
                       notation = RCLabels::arrow_notation)
rename_to_piece_byname(m_pieces, piece = "suff", margin = 2,
                       notation = RCLabels::arrow_notation)
```

These renamings can be used for aggregations
in which identically named rows and columns are summed
with `aggregate_byname()`.


## `aggregate_pieces_byname()`

`aggregate_pieces_byname()` bundles 
renaming and aggregating tasks in a single function call.
First, rows and/or columns are renamed to the requested `piece`
with the `rename_to_piece_byname()` function.
Then, aggregation is performed via `aggregate_byname()`,
according to an `aggregation_map` and the `pattern_type`,
if provided.
With the default `aggregation_map = NULL`, 
identically named pieces are aggregated together.

```{r}
m_pieces
# Aggregate Electricity in rows
aggregate_pieces_byname(m_pieces, piece = "pref", margin = 1, 
                        notation = RCLabels::bracket_notation)
# Aggregate useful energy types in columns
aggregate_pieces_byname(m_pieces, piece = "suff", margin = 2,
                        notation = RCLabels::arrow_notation)
```


When an `aggregation_map` is supplied,
it applies to the requested `piece`,
not to the original row and/or column names, as shown below.

```{r}
m_pieces
# Aggregate by original energy type
aggregate_pieces_byname(m_pieces, piece = "from", margin = 1, 
                        notation = RCLabels::bracket_notation, 
                        aggregation_map = list(`All sources` = c("Coal", "Solar")))

aggregate_pieces_byname(m_pieces, piece = "suff", margin = 2, 
                        notation = RCLabels::arrow_notation, 
                        aggregation_map = list(`Transport` = "MD"))
```


## Aggregations of lists and data frames of matrices

The functions for renaming and aggregating can be used on lists and data frames of matrices.

```{r}
m_pieces
res <- rename_to_piece_byname(list(m_pieces, m_pieces), 
                              piece = list("pref", "suff"), 
                              margin = list(1, 2),
                              notation = list(RCLabels::bracket_notation, 
                                              RCLabels::arrow_notation))
res
df <- tibble::tibble(mats = list(m_pieces, m_pieces), 
                     pce = list("suff", "pref"), 
                     mgn = list(1, 2), 
                     am = list(list(Sources = c("Coal", "Solar")), 
                               list(Transport = c("Motors", "Cars"))), 
                     notn = list(RCLabels::from_notation, RCLabels::arrow_notation))
df
res2 <- df %>%
  dplyr::mutate(
    aggregated = aggregate_pieces_byname(mats, piece = pce, margin = mgn, 
                                         aggregation_map = am, notation = notn)
  )
res2
res2$aggregated[[1]]
res2$aggregated[[2]]
```


## Summary

The `matsbyname` package simplifies aggregation of matrix rows and columns
based on row and column names
or pieces of row and column names. 
In particular the functions
`aggregate_byname()`, 
`rename_to_piece_byname()`, and 
`aggregate_pieces_byname()`
provide flexibility in how renaming and aggregation can be accomplished.