---
title: "Aggregation in `matsbyname`"
author: "Matthew Kuperus Heun"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    smart: false
vignette: >
  %\VignetteIndexEntry{Aggregation in `matsbyname`}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(dplyr)
library(tidyr)
library(matsbyname)
library(matsindf)
```


## Introduction

The `matsbyname` package provides several
functions to assist renaming and aggregating rows and columns of matrices.
This vignette shows how to use those functions.


## `aggregate_byname()`

By default (`aggregation_map = NULL, margin = c(1,2), pattern_type = "exact"`),
`aggregate_byname()` sums all rows and columns with the same names, 
with the effect that all row and column names are unique.

```{r}
m <- matrix(c(1, 2, 3, 
              4, 5, 6, 
              7, 8, 9), nrow = 3, ncol = 3, byrow = TRUE,
            dimnames = list(c("duck", "duck", "goose"), c("Coal", "Oil", "Solar")))
m
aggregate_byname(m)
```

An `aggregation_map` can be provided,
giving instructions for rows or columns to aggregate and 
the names of the aggregates.
`aggregation_map` should be a list of named strings.
The entries in the list give names of rows and columns to be aggregated.
The names of the list entries provide the names of the resulting aggregates.

```{r}
aggregate_byname(m, aggregation_map = list(birds = c("duck", "goose"), 
                                           `Fossil fuels` = c("Coal", "Oil")))
```

The margin over which the aggregation is to be performed 
is given in the `margin` argument
(1 for rows, 2 for columns). 

```{r}
aggregate_byname(m, aggregation_map = list(`Fossil fuels` = c("Coal", "Oil")), 
                 margin = 2)
```

Note that it is an error to aggregate over a margin and leave 
identically named rows or columns. 
The following function call will fail, 
because it aggregates over both rows and columns,
leaving two "duck" rows.

```{r, eval=FALSE}
# Not run
aggregate_byname(m, aggregation_map = list(`Fossil fuels` = c("Coal", "Oil")))
```


Aggregated rows and columns are sorted by name.

```{r}
aggregate_byname(m, aggregation_map = list(`zFossil fuels` = c("Coal", "Oil")), margin = 2)
```


## Pieces

Commonly, row and column names are complex, 
carrying information 
in prefixes, suffixes, and prepositional phrases.
`matsbyname` can aggregate by pieces of a name, too.
To do so, `matsbyname` uses the `RCLabels` package internally.

We'll use the following matrix to demonstrate aggregating by pieces.
The rows and columns use different notations for names
("bracket" notation for rows and "arrow" notation for columns). 
The renaming and aggregation capabilities of `matsbyname`
can aggregate the matrix, despite the different notations.

```{r}
m_pieces <- matrix(c(1, 2, 3,
                     4, 5, 6), nrow = 2, ncol = 3, byrow = TRUE, 
                   dimnames = list(c("Electricity [from Coal]", "Electricity [from Solar]"), 
                                   c("Motors -> MD", "Cars -> MD", "LED lamps -> Light")))
```



## `rename_to_piece_byname()`

```{r}
rename_to_piece_byname(m_pieces, piece = "pref", margin = 1, notation = RCLabels::bracket_notation)
rename_to_piece_byname(m_pieces, piece = "from", margin = 1, notation = RCLabels::bracket_notation)
rename_to_piece_byname(m_pieces, piece = "pref", margin = 2, notation = RCLabels::arrow_notation)
rename_to_piece_byname(m_pieces, piece = "suff", margin = 2, notation = RCLabels::arrow_notation)
```

Such renamings can be used for later aggregations
in which identically named rows and columns are aggregated
with `aggregate_byname()`.

`aggregate_pieces_byname()` bundles those tasks in a single function call.


## `aggregate_pieces_byname()`

The following code demonstrates aggregating by pieces.
The row and column names use different notations
("from" notation for rows and "arrow" notation for columns). 
Despite the different notations, 
aggregation is still possible.

```{r}
m_pieces <- matrix(c(1, 2, 3,
                     4, 5, 6), nrow = 2, ncol = 3, byrow = TRUE, 
                   dimnames = list(c("Electricity [from Coal]", "Electricity [from Solar]"), 
                                   c("Motors -> MD", "Cars -> MD", "LED lamps -> Light")))

# Aggregate Electricity in rows
aggregate_pieces_byname(m_pieces, piece = "pref", margin = 1, notation = RCLabels::bracket_notation)
# Aggregate instead by original energy type
aggregate_pieces_byname(m_pieces, piece = "from", margin = 1, notation = RCLabels::bracket_notation, 
                        aggregation_map = list(`All sources` = c("Coal", "Solar")))
```


## Summary

The `matsbyname` package simplifies aggregation of matrix rows and columns
based on row and column names. 
In particular the functions
`aggregate_byname()`, 
`rename_to_piece_byname()`, and 
`aggregate_pieces_byname()`
provide flexibility in how renaming and aggregation can be accomplished.